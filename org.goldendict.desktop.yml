app-id: org.goldendict.desktop
runtime: org.kde.Platform
runtime-version: '5.15'
sdk: org.kde.Sdk
base-version: '5.15'
command: goldendict
# separate-locales: false
base: io.qt.qtwebkit.BaseApp
finish-args:
  - --share=ipc
  # GoldenDict use lots of X11 functions and it currently cannot work
  # natively on Wayland.
  - --socket=x11
  - --device=dri # hardware acceleration
  - --socket=pulseaudio # videos/audios
  - --share=network
  - --talk-name=org.freedesktop.Notifications
rename-appdata-file: goldendict.appdata.xml
rename-desktop-file: goldendict.desktop
modules:
  - name: opencc
    buildsystem: cmake-ninja
    build-options:
      env:
        CC: 'ccache gcc'
        CXX: 'ccache g++'
    sources:
      - type: git
        url: https://github.com/BYVoid/OpenCC.git
        tag: ver.1.1.1
        x-checker-data:
          type: anitya
          project-id: 7230
          tag-template: ver.$version

  - name: lzo2
    config-opts:
      - '--enable-shared'
      - '--disable-static'
    cleanup:
      - /include
      - /share/doc
      - '*.la'
      - /lib/*.so
    sources:
      - type: archive
        url: 'https://www.oberhumer.com/opensource/lzo/download/lzo-2.10.tar.gz'
        sha256: c0f892943208266f9b6543b3ae308fab6284c5c90e627931446fb49b4221a072
        x-checker-data:
          type: anitya
          project-id: 1868
          url-template: http://www.oberhumer.com/opensource/lzo/download/lzo-$version.tar.gz

  - name: eb
    config-opts:
      - '--enable-shared'
      - '--disable-static'
    cleanup:
      - /bin
      - /share/doc
    sources:
      - type: git
        url: https://salsa.debian.org/debian/eb.git
        tag: debian/4.4.3-13
        x-checker-data:
          type: anitya
          project-id: 155542
          tag-template: debian/$version
      # Update config.guess & config.sub to allow builds for aarch64 and others
      # https://salsa.debian.org/debian/eb/-/merge_requests/3
      - type: file
        url: https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.guess;hb=6faca61810d335c7837f320733fe8e15a1431fc2
        dest-filename: config.guess
        sha256: 7d1e3c79b86de601c3a0457855ab854dffd15163f53c91edac54a7be2e9c931b
      - type: file
        url: https://git.savannah.gnu.org/gitweb/?p=config.git;a=blob_plain;f=config.sub;hb=6faca61810d335c7837f320733fe8e15a1431fc2
        dest-filename: config.sub
        sha256: b1016a1eb11cdf0903bbc533e42e8ac2cc4d54a80b0545f4f0af5a85198277e2

  - name: zstd
    buildsystem: meson
    subdir: build/meson
    config-opts:
      - -Dbin_programs=false
      - -Dbin_contrib=false
    sources:
      - type: git
        url: https://github.com/facebook/zstd.git
        tag: v1.4.8
        x-checker-data:
          type: anitya
          project-id: 12083
          tag-template: v$version

  - name: libao
    cleanup:
      - /include
      - '*.la'
      - /lib/pkgconfig
      - /lib/ckport
      - /share
    sources:
      - type: archive
        url: 'https://downloads.xiph.org/releases/ao/libao-1.2.0.tar.gz'
        sha256: 03ad231ad1f9d64b52474392d63c31197b0bc7bd416e58b1c10a329a5ed89caf
        x-checker-data:
          type: anitya
          project-id: 7629
          url-template: 'https://downloads.xiph.org/releases/ao/libao-$version.tar.gz'

  - name: goldendict
    buildsystem: qmake
    build-options:
      env:
        CC: 'ccache gcc'
        CXX: 'ccache g++'
        QMAKEPATH: '/app/lib'
        LD_LIBRARY_PATH: ${LD_LIBRARY_PATH}:/app/lib/:/usr/lib
    config-opts:
      - DEFINES+=USE_DBUS
      - INCLUDEPATH+="${FLATPAK_DEST}/include/QtWebKitWidgets"
      - INCLUDEPATH+="${FLATPAK_DEST}/include/QtWebKit"
      - CONFIG+=release
    build-commands:
      # https://github.com/goldendict/goldendict/pull/1354
      - desktop-file-edit --set-icon=${FLATPAK_ID} redist/goldendict.desktop
      # Put the version to the metadata
      - export VERSION=$(git rev-parse --short HEAD) # The same version as the upstream
      - appstream-util modify redist/goldendict.appdata.xml releases "<release version=\"${cat version.txt} (${VERSION}) \" date=\"${date --iso-8601}\"/>"
      - sed -i -e "s,<releases>&lt;,<releases><," -e "s,&gt;</releases>,></releases>," redist/goldendict.appdata.xml

      - make -j$FLATPAK_BUILDER_N_JOBS
      - make -j$FLATPAK_BUILDER_N_JOBS install
      - install -Dm644 redist/icons/goldendict.png ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png
    sources:
      - type: git
        url: https://github.com/goldendict/goldendict
        commit: 278c143a055a03934691557d9babb02c96c439e5
        x-checker-data:
          type: anitya
          project-id: 148566
          commit-template: v$version
      - type: patch
        path: rename-to-flatpak-id.patch
    cleanup:
      - /share/pixmaps
